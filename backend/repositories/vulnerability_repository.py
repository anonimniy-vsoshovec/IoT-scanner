from typing import Optional, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, desc

from repositories.base_repository import BaseRepository
from models.vulnerability import Vulnerability
from models.enums import VulnerabilitySeverity


class VulnerabilityRepository(BaseRepository[Vulnerability]):

    def __init__(self, session: AsyncSession):
        super().__init__(Vulnerability, session)

    async def get_by_device_id(self, device_id: int) -> List[Vulnerability]:
        result = await self.session.execute(
            select(Vulnerability).where(Vulnerability.device_id == device_id)
        )
        return list(result.scalars().all())

    async def get_by_severity(
        self, severity: VulnerabilitySeverity, skip: int = 0, limit: int = 100
    ) -> List[Vulnerability]:
        result = await self.session.execute(
            select(Vulnerability)
            .where(Vulnerability.severity == severity)
            .order_by(desc(Vulnerability.severity))
            .offset(skip)
            .limit(limit)
        )
        return list(result.scalars().all())

    async def get_filtered(
        self,
        device_id: Optional[int] = None,
        severity: Optional[VulnerabilitySeverity] = None,
        skip: int = 0,
        limit: int = 100,
    ) -> List[Vulnerability]:
        query = select(Vulnerability)

        if device_id:
            query = query.where(Vulnerability.device_id == device_id)

        if severity:
            query = query.where(Vulnerability.severity == severity)

        query = (
            query.order_by(desc(Vulnerability.severity))
            .offset(skip)
            .limit(limit)
        )

        result = await self.session.execute(query)
        return list(result.scalars().all())

    async def delete_by_device_id(self, device_id: int) -> int:
        result = await self.session.execute(
            select(Vulnerability).where(Vulnerability.device_id == device_id)
        )
        vulnerabilities = result.scalars().all()
        count = len(vulnerabilities)
        for vuln in vulnerabilities:
            await self.session.delete(vuln)
        await self.session.flush()
        return count
